# CPS 模型架构改进计划

## 📋 概述

本文档详细说明了CPS（Cell Positioning System）模型架构的当前问题及改进方案。基于对现有代码的分析，我们识别了多个架构层面的问题，并提出了具体的改进措施。

## 🔍 当前架构问题总结

### 1. 注意力机制设计问题
- **问题**: `TeacherNicheAttention`中查询向量的计算方式不合理
- **影响**: 可能导致多尺度信息融合不充分
- **优先级**: 高

### 2. 蒸馏策略不一致
- **问题**: 蒸馏损失设计逻辑不清晰，在对比学习和MSE之间随意切换
- **影响**: 训练不稳定，蒸馏效果不可预测
- **优先级**: 高

### 3. 训练循环效率问题
- **问题**: 缺少验证、早停和学习率调度
- **影响**: 训练效率低，可能过拟合
- **优先级**: 中

### 4. 解码器设计问题
- **问题**: 使用BatchNorm1d在推理时有问题
- **影响**: 单样本推理性能下降
- **优先级**: 中

### 5. 缺失关键功能
- **问题**: 多个核心方法只有占位符实现
- **影响**: 功能不完整，用户体验差
- **优先级**: 高

### 6. 配置参数设计问题
- **问题**: `k_list`包含0，在图卷积中无意义
- **影响**: 可能浪费计算资源
- **优先级**: 低

## 🚀 改进方案

### 阶段一：核心架构改进（高优先级）

#### 1.1 改进注意力机制
**目标**: 设计更合理的多尺度注意力融合机制

**具体改进**:
```python
# 当前问题代码（model.py第136-146行）：
# queries, keys, values = [], [], []
# for i, (q_proj, k_proj, v_proj) in enumerate(zip(self.query_projs, self.key_projs, self.value_projs)):
#     q = q_proj(scale_features[:,0,:]).reshape(N, self.num_heads, self.head_dim)
#     k = k_proj(scale_features[:,i,:]).reshape(N, self.num_heads, self.head_dim)
#     v = v_proj(scale_features[:,i,:]).reshape(N, self.num_heads, self.head_dim)
#     queries.append(q)
#     keys.append(k)
#     values.append(v)
# query = torch.mean(torch.stack(queries, dim=1), dim=1)

# 改进方案：
# 1. 为每个尺度生成独立的查询向量
# 2. 使用可学习的权重融合不同尺度的查询
# 3. 添加尺度间的交互机制
```

**预期效果**: 提高多尺度信息融合能力，增强模型表达能力

#### 1.2 统一蒸馏策略
**目标**: 设计理论依据充分的蒸馏框架

**具体改进**:
```python
# 当前问题代码（model.py第218-223行）：
# if self.projection_head is not None:
#     # 对比学习对齐
#     distill_loss = 1 - F.cosine_similarity(z_teacher_proj, z_student_proj).mean()
# else:
#     # MSE蒸馏
#     distill_loss = F.mse_loss(z_student, z_teacher.detach())

# 改进方案：
# 1. 提供多种蒸馏策略选项（MSE、KL散度、对比学习）
# 2. 添加温度参数控制蒸馏强度
# 3. 实现渐进式蒸馏（随着训练调整蒸馏权重）
```

**预期效果**: 提高蒸馏稳定性和效果

#### 1.3 实现缺失的核心功能
**目标**: 完善模型的功能完整性

**具体改进**:
1. 实现`infer_imputation_spots`方法：基于坐标生成基因表达
2. 实现`infer_imputation_genes`方法：基于现有spot插值基因表达
3. 实现`generate`方法：从潜在空间生成样本
4. 实现`interpret`方法：提供模型可解释性分析

### 阶段二：训练优化（中优先级）

#### 2.1 改进训练循环
**目标**: 添加完整的训练监控和优化机制

**具体改进**:
```python
# 当前问题代码（cps.py第31-38行）：
# for _ in tq.tqdm(range(1, self.args.max_epoch)):
#     self.optimizer.zero_grad()
#     results = self.model(pos, x, edge_index, return_attn=False)
#     losses = self.compute_losses(results, x, recon_weight=[0.5, 0.5])
#     losses['total'].backward()
#     torch.nn.utils.clip_grad_norm_(self.model.parameters(), 5)
#     self.optimizer.step()

# 改进方案：
# 1. 添加验证集监控
# 2. 实现早停机制（Early Stopping）
# 3. 添加学习率调度（ReduceLROnPlateau, CosineAnnealing）
# 4. 添加梯度累积支持大batch训练
# 5. 添加混合精度训练支持
```

#### 2.2 改进损失函数
**目标**: 设计更合理的损失权重分配

**具体改进**:
1. 添加可学习的损失权重
2. 实现自适应损失平衡
3. 添加正则化项防止过拟合

### 阶段三：架构优化（中低优先级）

#### 3.1 改进解码器设计
**目标**: 解决BatchNorm推理问题

**具体改进**:
```python
# 当前问题代码（model.py第180行）：
# layers += [nn.Linear(d, h), nn.BatchNorm1d(h), act]

# 改进方案：
# 1. 使用LayerNorm替代BatchNorm
# 2. 或实现推理时使用运行统计的BatchNorm
# 3. 添加GroupNorm选项
```

#### 3.2 优化配置参数
**目标**: 提供更合理的默认配置

**具体改进**:
1. 移除`k_list`中的0值
2. 添加配置验证逻辑
3. 提供针对不同数据集的预设配置

## 📊 实施路线图

### 第1周：核心架构重构
- [ ] 重新设计注意力机制
- [ ] 统一蒸馏策略
- [ ] 实现缺失的核心功能方法
- [ ] 编写单元测试验证功能

### 第2周：训练优化
- [ ] 改进训练循环，添加验证和早停
- [ ] 实现学习率调度
- [ ] 添加混合精度训练支持
- [ ] 优化损失函数设计

### 第3周：架构优化和测试
- [ ] 改进解码器设计
- [ ] 优化配置参数
- [ ] 进行基准测试
- [ ] 性能调优

### 第4周：文档和部署
- [ ] 更新API文档
- [ ] 编写使用示例
- [ ] 创建性能对比报告
- [ ] 准备发布版本

## 🧪 测试计划

### 单元测试
1. **注意力机制测试**: 验证多尺度注意力权重计算正确性
2. **蒸馏测试**: 验证不同蒸馏策略的效果
3. **推理测试**: 验证插值和生成功能的正确性

### 集成测试
1. **端到端训练测试**: 完整训练流程验证
2. **性能基准测试**: 与原始版本性能对比
3. **内存和速度测试**: 优化前后的性能对比

### 验证数据集
1. **DLPFC数据集**: 标准Visium数据
2. **HBC数据集**: VisiumHD高分辨率数据
3. **合成数据**: 验证插值准确性

## 📈 预期效果

### 性能提升
1. **训练稳定性**: 提高20-30%
2. **模型性能**: 在重建任务上提升5-10%的准确率
3. **训练速度**: 通过混合精度训练提升30-50%

### 功能完善
1. **功能完整性**: 实现所有核心功能
2. **用户体验**: 提供更友好的API和配置
3. **可扩展性**: 支持更多类型的空间转录组数据

## 🔧 技术风险与缓解

### 风险1：注意力机制改进可能破坏现有功能
- **缓解**: 保留原始实现作为选项，逐步迁移

### 风险2：蒸馏策略改变可能导致训练不稳定
- **缓解**: 提供多种策略选项，进行充分的超参数调优

### 风险3：架构改变可能影响向后兼容性
- **缓解**: 提供版本迁移指南，保持关键API不变

## 🤝 责任分配

- **架构设计**: 核心团队
- **代码实现**: 开发团队
- **测试验证**: QA团队
- **文档更新**: 技术写作团队

## 📞 沟通计划

- **每周进度会议**: 周一上午
- **技术评审**: 每阶段完成后
- **问题跟踪**: 使用GitHub Issues
- **文档更新**: 实时更新项目Wiki

---

**最后更新**: 2025-12-27  
**版本**: 1.0  
**状态**: 草案（待评审）